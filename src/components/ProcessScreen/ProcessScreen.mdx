# Process

Modern modules automate as much as possible in the project. Small modules make for better
composition, but there is a maintenance cost for every module created. Automating as much
of the module 'infrastructure' as possible helps keep maintenance up to date which reduces
the dreaded _software erosion_.

---

## Repository management

- Consistently use labels for grouping issues across repositories by using the issue
  labels script in `scripts/create-github-labels.js`
- Declutter repository header tabs by disabling wikis and projects in the
  _Settings.Options:Features_ settings. Documentation should be maintained in a `/docs`
  directory and project management should use ZenHub releases and projects.
- Keep a streamlined git history by disabling merge commits and rebase merging in the
  _Settings.Options:Merge Button_ settings.
- Keep branches cleaned up by enabling automatically deleting head branches in the
  _Settings.Options:Merge Button_ settings.
- Only define needed configuration files by using the shared issue and pull request
  templates defined in the [.github](https://github.com/crystal-ball/.github) template
  repository.
- Provide details on how to contribute with a contributing guide in
  `.github/contributing.md`. Include a guide in each repo so that additional notes can be
  added for the design of that specific repository.
- Support community health by including a copy of the Contributor Covenant code of conduct
  in the repository root. _(Although it's possible to include a code of conduct in the
  .github template repository, it should be included in each repo root for visibility
  because it's important)_

## Dependencies management

Dependencies management is automated with [Renovate][].

- Dependency version change visibility is increased by pinning all versions.
- Project dependency resolution is locked across builds by including lock files.
- Package dependency resolution happens at build time by not including lock files. This is
  meant to provide more realistic testing during CI/CD by mirroring how the package
  dependencies will be resolved when installed by a consumer.
- Updates follow a waterfall schedule through the week to allow consumers to update to the
  most recent versions.

#### npm configuration

All repositories should include an `.npmrc` config file setting dependency additions to
exact versions. Packages should also disable lock files.

```
save-exact=true
# Package lock files disabled:
package-lock=false
```

#### Package dependencies semver

Packages should use minor ranges for any dependencies that might also be included by other
packages to prevent multiple versions being required _(eg if `nanoid` is a dependency it
should be specified with a `^` range)_. Dependencies that are explicitly managed by that
package can be pinned for better version control _(eg the `@crystal-ball/webpack-base`
package should pin the `webpack` dependency)_.

#### Monitoring dependency vulnerabilities

Dependency vulnerabilities monitoring is setup with [Snyk][]. Automated security fix PRs
are currently disabled due to confusion of how they are applied. The Github integration
will include a check for all PRs to notify if the change introduces any new high severity
vulnerabilities.

<!-- prettier-ignore-start -->
[Renovate]:https://docs.renovatebot.com/
[Snyk]:https://snyk.io/
<!-- prettier-ignore-end -->

## Badges

It's all for the badges.

- <img
    src='https://img.shields.io/npm/v/componentry'
    alt='Package version'
    valign='text-top'
  />
- <img
    src='https://img.shields.io/bundlephobia/minzip/componentry'
    alt='Bundle size'
    valign='text-top'
  />
- <img
    src='https://img.shields.io/npm/dt/componentry?color=blue'
    alt='NPM downloads'
    valign='text-top'
  />
- <img
    src='https://github.com/crystal-ball/crystal-ball.github.io/workflows/CI%2FCD/badge.svg'
    alt='Build status'
    valign='text-top'
  />
- <img
    src='https://snyk.io/test/github/crystal-ball/crystal-ball.github.io/badge.svg?targetFile=package.json'
    alt='Known vulnerabilities'
    valign='text-top'
  />
- <img
    src='https://img.shields.io/badge/Cypress-dashboard-brightgreen.svg'
    alt='Cypress dashboard'
    valign='text-top'
  />
- <img
    src='https://api.codeclimate.com/v1/badges/70b90e52c78b35ab947a/test_coverage'
    alt='Test coverage'
    valign='text-top'
  />
- <img
    src='https://api.codeclimate.com/v1/badges/70b90e52c78b35ab947a/maintainability'
    alt='Maintainability'
    valign='text-top'
  />
- <img
    src='https://img.shields.io/badge/hosting-▲%20Zeit-7de0c4'
    alt='Zeit Now'
    valign='text-top'
  />
- <img
    src='https://img.shields.io/badge/Renovate-enabled-32c3c2.svg'
    alt='Renovate'
    valign='text-top'
  />
- <img
    src='https://img.shields.io/badge/Commitizen-%E2%9C%93%20friendly-10e67b'
    alt='Commitizen friendly'
    valign='text-top'
  />
- <img
    src='https://img.shields.io/badge/ZenHub-managed-5e60ba.svg'
    alt='ZenHub'
    valign='text-top'
  />
- <img
    src='https://img.shields.io/badge/testing-%F0%9F%A6%94%20Percy-9e66bf'
    alt='Percy snapshot testing'
    valign='text-top'
  />
- <img
    src='https://img.shields.io/badge/%F0%9F%93%A6%F0%9F%9A%80-semantic_release-e10079.svg'
    alt='Semantic Release'
    valign='text-top'
  />
- <img
    src='https://img.shields.io/badge/Contributor%20Covenant-v2.0-de8cf2.svg'
    alt='Contributor Covenant'
    valign='text-top'
  />
- <img
    src='https://img.shields.io/badge/%F0%9F%94%AE%E2%9C%A8-contains_magic-D831D7.svg'
    alt='Contains magic'
    valign='text-top'
  />
- <img
    src='https://img.shields.io/badge/%F0%9F%92%96%F0%9F%8C%88-full_of_love-F5499E.svg'
    alt='Full of love'
    valign='text-top'
  />

- Design custom badges using [Shields IO](https://shields.io/).
- Include logos from [Simple Icons](https://simpleicons.org) for badges with integrations.

## Project management

- Keep the ZenHub board relevant and easy to work within by documenting long term
  repository goals and ideas in the _Roadmap_ section of the Contributing doc.

<!-- Editing finished -->

# Continuous Integration and Deployment

_Configure github actions for each repo to handle testing each pull request and deploying
on change to master._

## Continous integration

- Always use `npm ci` in CI/CD builds for apps/services to install from the package
  lockfile.
- Github action configuration
- Zeit for applications
- Should build and run tests for each PR

## Continuous deployment

- Github action configuration
- Should use Semantic Release for publishing npm packages. Include package.json release
  field to configure:

  ```json
  {
    "release": {
      "extends": ["@crystal-ball/semantic-release-base"]
    }
  }
  ```

## Providing commit info for Cypress+Percy

Because CI runs in Docker, on pull requests, Cypress+Percy are unable to determine the git
info for the merge commit being tested and show _unknown_/`HEAD` as the branch. This is
fixed by checking for a merging branch commit SHA in the `github` workflow context. If it
exists it's used to determine the commit info for the test run, otherwise the Github
Action workflow env variables contain the correct info for master branch pushes.

# Commits

_*Goal* Automate generating a changelog and determining package version for a release
using its commits._

#### Workflow

1. Use [`husky`][] and [`commitizen`][] to create a pre-commit hook with Commitizen
   interactive prompts to create commits.
1. Use the Github [Commit Lint][] app to add a check to PRs linting commit format.
1. (TBD) Use [`semantic-release`][] to manage all publish tasks, including tags,
   changelogs and npm publishing

#### Commit format

The [ESLint commit format][] is automatically constructed by Commitizen.

#### Commitizen+Husky

_Install dependencies_

```
npm i -D commitizen cz-adapter-eslint husky
```

_Add git hook with Husky_

```
  "husky": {
    "hooks": {
      "prepare-commit-msg": "exec < /dev/tty && git cz --hook"
    }
  }
```

<!-- Links -->

[`husky`]: https://github.com/typicode/husky
[`commitizen`]: https://github.com/commitizen/cz-cli
[`semantic-release`]: https://github.com/semantic-release/semantic-release
[commit lint]: https://www.commit-lint.com/
[eslint commit guidelines]:
  https://eslint.org/docs/developer-guide/contributing/pull-requests#step-2-make-your-changes

# Releases

!Make it automated

Docs on setting up automated releases with semantic

In CI run: `npx semantic-release`

Include semantic-release-base config in `package.json`

```
{
  "release": {
    "extends": ["@crystal-ball/semantic-release-base"]
  }
}
```

#### Github Actions

...TODO

# Writing documentation

- Keep the project Readme focused on providing an overview of the project and workflows,
  details can be documented in a guide.
- Project guides or detailed code documentation should be kept in guides in the `docs`
  dir.

## Integrations

### Code Climate

_Integration with Code Climate provides fun visuals for project code coverage and some
general maintainability best practices._

- https://codeclimate.com/oss/dashboard

#### Setup

Adding a repo to the Code Coverage org will automatically provide maintainability coverage
🎉 Add code coverage by:

1. In Code Climate dashboard's _Repo Settings_, _Exclude patterns_ add test files patterns
   to exclude test files from code coverage totals
   ```
   cypress/
   **/*.spec.js
   ```

- Output `lcov` code coverage reports from Jest
- Add a `CC_TEST_REPORTER_ID` env var to Travis from the `/settings/test_reporter/` Code
  Climate dashboard.
- Add `before_script` and `after_script` lifecycles to `.travis.yml` to install and call
  the Code Climate reporter.
- Add the badges!

#### Working with Docker containers

Code coverage from tests run inside of a Docker container need to have the path included
when reporting the results. Eg if the tests ran at `/usr/src/app` then the call to the
reporter would need to be:

- `cc-test-reporter format-coverage --prefix /usr/src/app --exit-code $TRAVIS_TEST_RESULT`

> ℹ️ `--exit-code` prevents sending test coverage for failed tests

### Commitizen

...

### Cypress

<div align='center'>
  <em>Cypress provides fun! end to end testing for React applications 🎉</em>
</div>

- https://dashboard.cypress.io/

- CI HANDLING REPORTING TO PROJECT DASHBOARD OF RESULTS
- USING DOCKER COMPOSE AND INCLUDED IMAGE FOR FASTER RUNS
- TRAVIS ENV VARIABLE AND REPORTER FLAGS

#### CI Workflow

**Better?**

- Is there a way to conditionally include the `--record` flag and record key for CI runs
  without using a separate Compose file

#### Badge

```html
<a href="https://dashboard.cypress.io/#/projects/PROJECT-ID/runs">
  <img
    src="https://img.shields.io/badge/cypress-dashboard-brightgreen.svg"
    alt="Cypress Dashboard"
  />
</a>
```

#### Ref

- Setting up a Cypress project:
  https://docs.cypress.io/guides/dashboard/projects.html#Setup
- Continuous integration:
  https://docs.cypress.io/guides/guides/continuous-integration.html#Setting-up-CI
- Blog post on cypress/included workflow:
  https://www.cypress.io/blog/2019/05/02/run-cypress-with-a-single-docker-command/
- Example repo with Cypress and Docker Compose:
  https://github.com/cypress-io/cypress-example-docker-compose
- Cypress Github integration:
  https://docs.cypress.io/guides/dashboard/github-integration.html#Install-the-Cypress-GitHub-app
- Only building `master` with whitelist:
  https://docs.travis-ci.com/user/customizing-the-build/#building-specific-branches

<!-- Links -->
<!-- prettier-ignore-start -->
[Percy environment variables]:https://docs.percy.io/v1/docs/environment-variables
<!-- prettier-ignore-end -->

# MDX

MDX operates by parsing the markdown into an AST using [remark][] and then generating HTML
from the AST using [rehype][]. remark and rehype are part of the [unifiedjs][] collective

### Setup

1. Install and configure the loader

```shell
npm i -D @mdx-js/loader
```

```js
configs.rules.push({
  test: /\.mdx$/,
  use: ['babel-loader', '@mdx-js/loader'],
})
```

Test adding a link here: [Crystal Ball Projects](https://github.com/crystal-ball)

- [Syntax Highlighting](https://mdxjs.com/guides/syntax-highlighting)

### Syntax highlighting

The two methods of adding code block syntax highlighting outlined in the MDX docs are:

1. Use the [`@mapbox/rehype-prism`][] rehype plugin. The plugin operates during the build
   and adds 0 weight to the vendor bundle, but the result is more opaque for adding
   additional behavior to rendered React elements.
1. Using the `prism-react-renderer` package with a custom `CodeBlock` component set on the
   MDX provider context. The component operates similar to downshift and will allow for
   additional behaviors to be added into the rendered code, but the packages add `26Kb` to
   the vendor bundle weight after _gzip_!.

<!-- Links -->

<!-- prettier-ignore-start -->
[remark]:https://remark.js.org/
[rehype]:https://github.com/rehypejs/rehype
[unifiedjs]:https://unifiedjs.com/
[`@mapbox/rehype-prism`]:https://github.com/mapbox/rehype-prism
[`prism-react-renderer`]:https://github.com/FormidableLabs/prism-react-renderer
<!-- prettier-ignore-end -->

# Percy

[Percy](https://docs.percy.io/docs) provides visual regression testing. It is integrated
with Cypress and takes snapshots during acceptance tests.

## Setup

1. Install the dependency: `@percy/cypress`
1. Setup healthcheck in `cypress/plugins/index.js`
1. Import command in `cypress/support/index.js`
1. Get `PERCY_TOKEN` from Percy dashboard and add to CI/CD secrets
1. Add a Dockerfile to `cypress` dir to enable installing additional testing dependencies
   for Cypress and overriding the run command to use Percy
1. The Percy app isn't able to determine the branch for PRs or for Docker runs, Set a
   `PERCY_BRANCH` environment variable to fix.

_See *CI-CD#Providing commit info for Cypress+Percy* for details on parsing out commit
info during workflow runs._

### Ref

- [Percy environment variables][] are used to instruct Percy which branch is being tested.
- [Percy tutorials][] has example apps for using with Cypress and Storybook.

<!-- Links -->
<!-- prettier-ignore-start -->
[Percy environment variables]:https://docs.percy.io/v1/docs/environment-variables
[Percy tutorials]:https://docs.percy.io/docs/example-apps
<!-- prettier-ignore-end -->

# Prettier

- USING PRETTIER TO AUTOMATE FORMATTING EVERYTHING

```json
{
  "format": "prettier --write '*.{md,js,json,yml}' '{.storybook,docs,cypress,src,test}/**/*.{html,md,js,scss}'"
}
```

# Pull Panda

...notifications and reminders for when PRs are open.

# Renovate

Repository access for the Renovate Github app is configured in the [Github org installed
apps settings][installed-apps]. For individual repository setup, Renovate will
automatically open an initial configuration PR after adding access for a repository.

- Renovate configurations should match the [Renovate standard
  configuration][renovate.json] maintained in this repository.
  - The `commitMessageTopic` should be customized to either `application`, `service` or
    `package` depending on the repository.
  - The `schedule` should be set to match the repository type.
- Dependency update PR titles: `Update: Application dependencies upgrades 🆙`
- Dev dependency update PR titles: `Chore: Update application dev dependencies 🆙`
- A master issue is created for each repo just for funesies and all Renovate PRs are
  labeled with the `Renovate` label.
- Updates for dependencies and devDependencies are separated in order to prevent
  publishing new package versions for development+testing dependency updates.
- Config `separateMajorMinor` is left `false` to provide higher visibility for updates
  with major version bumps. It is also possible to delay a major version update if
  necessary (eg when waiting for community Babel support).

#### Schedule

- Monday: Authoring tools (eg semantic-release-base, commitizen-base, prettier-base)
- Tuesday: Development toolsets (eg webpack-base, svg-symbol-sprite-loader)
- Wednesday: Prototypes (eg react-application-prototype)
- Thursday: Projects (eg gitpush-f, hecka-rad)

<!-- prettier-ignore-start -->
[renovate.json]:https://github.com/crystal-ball/crystal-ball.github.io/blob/master/renovate.json
[Renovate Docs](https://docs.renovatebot.com/)
<!-- prettier-ignore-end -->

# Semantic Release

...automates publishing packages

# Slack

...getting notifications in Slack channels by repo

# Snyk

Repository access for Snyk is configured in the [Github org third party access
setting][app-access]. Vulnerabilities reporting and badge info is available in the
[Snyk dashboard](https://app.snyk.io/org/crystal-ball/projects)

# Zeit

1. Set an `engines` in `package.json` to configure the version of Node.js used by the
   static builder
   ([Static Build Project Node.js Version](https://zeit.co/docs/builders#official-builders/static-builds/static-build-project-node-js-version))
2. Include build variables to prevent Cypress binary from being installed for faster
   builds.
   ([Cypress - Skipping Installation](https://docs.cypress.io/guides/getting-started/installing-cypress.html#Skipping-installation))
3. Add a route config for all resources to add a `cache-control` header for long term
   caching of webpack hashed build assets.
   ([Zeit configuration - headers](https://zeit.co/docs/configuration/#routes/headers))
4. Add a route config that rewrites all requests to `/` to support single page app
   `index.html` resolution
   ([Zeit configuration - SPA Fallback](https://zeit.co/docs/configuration/#routes/advanced/spa-fallback))

# ZenHub

...the best!

<!-- prettier-ignore-start -->
[app-access]:https://github.com/organizations/crystal-ball/settings/oauth_application_policy
[installed-apps]:https://github.com/organizations/crystal-ball/settings/installations
<!-- prettier-ignore-end -->
